<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>대순진리회 소통의 광장</title>
  <meta name="description" content="대순진리회 소통의 광장 — 공지 및 게시판" />
  <style>
    :root{
      --bg:#0b1020; --card:#121a32; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#4f46e5; --accent2:#22d3ee; --ring:rgba(34,211,238,.35);
      --shadow:0 20px 45px rgba(0,0,0,.35); --r:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Pretendard, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 10% 0%, rgba(79,70,229,.25), transparent 60%),
                  radial-gradient(1000px 600px at 90% 0%, rgba(34,211,238,.2), transparent 60%),
                  var(--bg);
      line-height:1.6;
    }
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:rgba(11,16,32,.85);border-bottom:1px solid rgba(99,102,241,.2)}
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .title-row{display:flex;align-items:center;gap:12px}
    .title{font-weight:800;letter-spacing:-.02em;font-size:22px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(34,211,238,.35);background:rgba(34,211,238,.12);color:#bbf7fe}
    .muted{color:var(--muted)}
    .card{background:rgba(18,26,50,.9);border:1px solid rgba(148,163,184,.15);border-radius:var(--r);box-shadow:var(--shadow);margin:22px 0 0}
    .inner{padding:22px}
    h1,h2,h3{margin:0 0 12px}
    .list{list-style:none;padding:0;margin:0;display:grid;gap:12px}
    .item{border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:12px 16px;background:rgba(255,255,255,.02)}
    .row{display:flex;align-items:center;gap:10px}
    .no{background:rgba(34,211,238,.15);border:1px solid rgba(34,211,238,.3);color:#a5f3fc;border-radius:8px;padding:4px 8px;font-size:12px}
    .tit{cursor:pointer;font-weight:700;color:#e0e7ff}
    .tit:hover{text-decoration:underline}
    .meta{margin-left:auto;font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:center}
    .views{font-size:12px;color:#cbd5e1}
    .body{display:none;margin-top:10px;color:#cbd5e1;white-space:pre-line}
    .pagination{display:flex;justify-content:center;gap:8px;margin-top:14px;flex-wrap:wrap}
    .page{border:1px solid rgba(148,163,184,.25);background:rgba(255,255,255,.03);padding:6px 10px;border-radius:10px;cursor:pointer}
    .page[aria-current="page"]{border-color:#22d3ee;font-weight:800;box-shadow:0 0 0 3px rgba(34,211,238,.18)}
    .form{display:grid;gap:10px;margin-top:14px}
    .row2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:680px){.row2{grid-template-columns:1fr}}
    input[type=text], textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.25);
      background:rgba(255,255,255,.03);color:var(--text);outline:none;
    }
    input[type=text]:focus, textarea:focus{border-color:var(--accent2);box-shadow:0 0 0 4px var(--ring)}
    textarea{min-height:110px;resize:vertical}
    .btn{border:1px solid rgba(148,163,184,.28);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding:10px 14px;border-radius:12px;color:#e5e7eb;cursor:pointer}
    footer{text-align:center;color:var(--muted);font-size:14px;margin:40px 0}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title-row">
      <div class="title">대순진리회 소통의 광장</div>
      <span id="homeViews" class="pill" title="홈 조회수">조회수 0</span>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- 공지 -->
  <section class="card">
    <div class="inner">
      <h2>공지</h2>
      <ul id="noticeList" class="list" aria-live="polite"></ul>
      <div id="noticeEmpty" class="muted">등록된 공지가 없습니다.</div>
    </div>
  </section>

  <!-- 게시판 -->
  <section class="card">
    <div class="inner">
      <h2>게시판</h2>
      <ul id="boardList" class="list" aria-live="polite"></ul>
      <div id="boardEmpty" class="muted">등록된 게시글이 없습니다.</div>
      <nav id="pagination" class="pagination" aria-label="게시판 페이지"></nav>

      <!-- 글쓰기 -->
      <div class="form">
        <div class="row2">
          <input id="postTitle" type="text" placeholder="제목" aria-label="게시글 제목" />
          <input id="postAuthor" type="text" placeholder="작성자 (선택)" aria-label="게시글 작성자" />
        </div>
        <textarea id="postBody" placeholder="내용" aria-label="게시글 내용"></textarea>
        <button class="btn" id="postBtn">게시하기</button>
      </div>
    </div>
  </section>
</main>

<footer>© <span id="year"></span> 대순진리회 소통의 광장</footer>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot,
  doc, getDoc, setDoc, updateDoc, increment, where, getDocs
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// Firebase 설정(본인 값으로 교체)
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const db  = getFirestore(app);

const $ = (s)=>document.querySelector(s);
$("#year").textContent = new Date().getFullYear();
const fmt = (ts)=> ts?.toDate ? ts.toDate().toLocaleString("ko-KR",{dateStyle:"medium", timeStyle:"short"}) : "";

// -------------------- 홈 조회수 (세션당 1회) --------------------
(async ()=>{
  try{
    const homeBadge = $("#homeViews");
    const key = "homeViewed";
    const ref = doc(db, "stats", "home");
    if (!sessionStorage.getItem(key)){
      await setDoc(ref, { views: increment(1) }, { merge: true });
      sessionStorage.setItem(key, "1");
    }
    const snap = await getDoc(ref);
    const views = snap.exists() && snap.data().views ? snap.data().views : 1;
    if (homeBadge) homeBadge.textContent = `조회수 ${views}`;
  }catch(e){ console.warn("홈 조회수 오류:", e.message); }
})();

// -------------------- 공지 (제목 클릭 → 본문 토글 + 조회수) --------------------
const noticesRef = collection(db, "notices");
const noticeUl = $("#noticeList");
const noticeEmpty = $("#noticeEmpty");

onSnapshot(query(noticesRef, orderBy("createdAt","desc")), (snap)=>{
  noticeUl.innerHTML = "";
  if (snap.empty){ noticeEmpty.style.display="block"; return; }
  noticeEmpty.style.display="none";

  snap.forEach(d=>{
    const n = d.data();
    const id = d.id;
    const li = document.createElement("li");
    li.className = "item";

    const title = document.createElement("div");
    title.className = "row";
    title.innerHTML = \`
      <div class="no">공지</div>
      <div class="tit">\${n.title}</div>
      <div class="meta">
        <span>\${fmt(n.createdAt)}</span>
        <span class="views" id="notice-views-\${id}">조회수 \${n.views || 0}</span>
      </div>
    \`;

    const body = document.createElement("div");
    body.className = "body";
    body.textContent = n.body || "";

    title.querySelector(".tit").addEventListener("click", async ()=>{
      const wasOpen = body.style.display === "block";
      body.style.display = wasOpen ? "none" : "block";
      if (!wasOpen){
        // 조회수 증가 (세션당 1회/공지)
        const seenKey = "noticeViewed:" + id;
        if (!sessionStorage.getItem(seenKey)){
          try{
            await updateDoc(doc(db, "notices", id), { views: increment(1) });
            sessionStorage.setItem(seenKey, "1");
            const el = document.getElementById("notice-views-" + id);
            if (el){
              const cur = Number((n.views||0)) + 1;
              el.textContent = "조회수 " + cur;
              n.views = cur;
            }
          }catch(e){ console.warn("공지 조회수 증가 실패:", e.message); }
        }
      }
    });

    li.appendChild(title);
    li.appendChild(body);
    noticeUl.appendChild(li);
  });
}, (err)=>{ console.warn("공지 읽기 오류:", err.message); });

// -------------------- 게시판 (페이지당 5개 + 조회수) --------------------
const postsRef   = collection(db, "posts");
const postUl     = $("#boardList");
const boardEmpty = $("#boardEmpty");
const pagination = $("#pagination");

const PAGE_SIZE = 5;
let allPosts = [];
let currentPage = 1;

function renderPage(page=1){
  postUl.innerHTML = "";
  const start = (page-1)*PAGE_SIZE;
  const pagePosts = allPosts.slice(start, start+PAGE_SIZE);
  if (!pagePosts.length){ boardEmpty.style.display="block"; return; }
  boardEmpty.style.display="none";

  pagePosts.forEach((p, idx)=>{
    const li = document.createElement("li");
    li.className = "item";

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = \`
      <div class="no">\${allPosts.length - (start + idx)}</div>
      <div class="tit">\${p.title || "(제목 없음)"}</div>
      <div class="meta">
        <span>\${p.author || "익명"} · \${fmt(p.createdAt)}</span>
        <span class="views" id="post-views-\${p.id}">조회수 \${p.views || 0}</span>
      </div>
    \`;

    const body = document.createElement("div");
    body.className = "body";
    body.textContent = p.body || "";

    row.querySelector(".tit").addEventListener("click", async ()=>{
      const wasOpen = body.style.display === "block";
      body.style.display = wasOpen ? "none" : "block";
      if (!wasOpen){
        // 조회수 증가 (세션당 1회/게시글)
        const seenKey = "postViewed:" + p.id;
        if (!sessionStorage.getItem(seenKey)){
          try{
            await updateDoc(doc(db, "posts", p.id), { views: increment(1) });
            sessionStorage.setItem(seenKey, "1");
            const el = document.getElementById("post-views-" + p.id);
            if (el){
              const cur = Number((p.views||0)) + 1;
              el.textContent = "조회수 " + cur;
              p.views = cur;
            }
          }catch(e){ console.warn("게시글 조회수 증가 실패:", e.message); }
        }
      }
    });

    li.appendChild(row);
    li.appendChild(body);
    postUl.appendChild(li);
  });

  renderPagination(page);
}

function renderPagination(page){
  pagination.innerHTML = "";
  const totalPages = Math.max(1, Math.ceil(allPosts.length / PAGE_SIZE));
  for (let i=1; i<=totalPages; i++){
    const btn = document.createElement("button");
    btn.className = "page";
    btn.textContent = i;
    if (i===page) btn.setAttribute("aria-current","page");
    btn.addEventListener("click",()=>{ currentPage=i; renderPage(i); });
    pagination.appendChild(btn);
  }
}

onSnapshot(query(postsRef, orderBy("createdAt","desc")), (snap)=>{
  allPosts = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  renderPage(1);
}, (err)=>{ console.warn("게시판 읽기 오류:", err.message); });

// -------------------- 글쓰기 (로그인 없이) --------------------
const postBtn    = document.getElementById("postBtn");
const postTitle  = document.getElementById("postTitle");
const postAuthor = document.getElementById("postAuthor");
const postBody   = document.getElementById("postBody");

postBtn.addEventListener("click", async ()=>{
  const title = (postTitle.value||"").trim();
  const author= (postAuthor.value||"").trim();
  const body  = (postBody.value||"").trim();
  if (!title || !body){ alert("제목과 내용을 입력해 주세요."); return; }
  try{
    await addDoc(postsRef, { title, author, body, views: 0, createdAt: serverTimestamp() });
    postTitle.value = ""; postAuthor.value=""; postBody.value="";
  }catch(e){
    alert("등록 실패: " + e.message);
  }
});

// -------------------- (선택) 공지 자동 등록 시드 --------------------
// URL 뒤에 ?seedNotice=1 또는 #seed-notice 를 붙여 접속하면
// 같은 제목 공지가 없을 때만 1회 등록합니다.
(async ()=>{
  try{
    const url = new URL(window.location.href);
    const shouldSeed = url.searchParams.get("seedNotice")==="1" || window.location.hash==="#seed-notice";
    if (!shouldSeed) return;

    const requiredTitle = "종단소식 공유 사이트 개설 공지";
    const requiredBody = "공지 본문을 여기에 붙여넣어 주세요.";

    const noticesCol = collection(db, "notices");
    const exists = await getDocs(query(noticesCol, where("title","==", requiredTitle)));
    if (exists.empty){
      await addDoc(noticesCol, { title: requiredTitle, body: requiredBody, views: 0, createdAt: serverTimestamp() });
      alert("공지 1건을 등록했습니다.");
    }
  }catch(e){ console.warn("공지 시드 실패:", e); }
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>대순소식 — 게시판</title>
  <meta name="description" content="로그인 없이 글 작성 가능한 공지/게시판 (Firebase Firestore)" />
  <style>
    :root{
      --bg:#0b1020; --card:#121a32; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#4f46e5; --accent2:#22d3ee; --ring:rgba(34,211,238,.35);
      --shadow:0 20px 45px rgba(0,0,0,.35); --r:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Pretendard, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 10% 0%, rgba(79,70,229,.25), transparent 60%),
                  radial-gradient(1000px 600px at 90% 0%, rgba(34,211,238,.2), transparent 60%),
                  var(--bg);
      line-height:1.6;
    }
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:rgba(11,16,32,.85);border-bottom:1px solid rgba(99,102,241,.2)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .brand{display:flex;align-items:center;gap:14px}
    .title{font-weight:800;letter-spacing:-.02em;font-size:22px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(34,211,238,.35);background:rgba(34,211,238,.12);color:#bbf7fe}
    .grid{display:grid;gap:24px;margin-top:24px;grid-template-columns:1.1fr .9fr}
    @media (max-width: 960px){ .grid{ grid-template-columns:1fr; } }
    .card{background:rgba(18,26,50,.9);border:1px solid rgba(148,163,184,.15);border-radius:var(--r);box-shadow:var(--shadow)}
    .inner{padding:22px}
    h1,h2,h3{margin:0 0 12px}
    .list{list-style:none;padding:0;margin:0;display:grid;gap:12px}
    .item{border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:12px 16px;background:rgba(255,255,255,.02)}
    .row{display:flex;align-items:center;gap:10px}
    .no{background:rgba(34,211,238,.15);border:1px solid rgba(34,211,238,.3);color:#a5f3fc;border-radius:8px;padding:4px 8px;font-size:12px}
    .tit{cursor:pointer;font-weight:700;color:#e0e7ff}
    .tit:hover{text-decoration:underline}
    .meta{margin-left:auto;font-size:12px;color:#94a3b8;display:flex;gap:10px;align-items:center}
    .views{font-size:12px;color:#cbd5e1}
    .body{display:none;margin-top:10px;color:#cbd5e1;white-space:pre-line}
    .pagination{display:flex;justify-content:center;gap:8px;margin-top:14px;flex-wrap:wrap}
    .page{border:1px solid rgba(148,163,184,.25);background:rgba(255,255,255,.03);padding:6px 10px;border-radius:10px;cursor:pointer}
    .page[aria-current="page"]{border-color:#22d3ee;font-weight:800;box-shadow:0 0 0 3px rgba(34,211,238,.18)}
    .form{display:grid;gap:10px;margin-top:14px}
    .row2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:680px){.row2{grid-template-columns:1fr}}
    input[type=text], textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.25);
      background:rgba(255,255,255,.03);color:var(--text);outline:none;
    }
    input[type=text]:focus, textarea:focus{border-color:#22d3ee;box-shadow:0 0 0 4px var(--ring)}
    textarea{min-height:110px;resize:vertical}
    .btn{border:1px solid rgba(148,163,184,.28);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));padding:10px 14px;border-radius:12px;color:#e5e7eb;cursor:pointer}
    footer{text-align:center;color:#94a3b8;font-size:14px;margin:40px 0}
  </style>
</head>
<body>
<header>
  <div class="container brand">
    <div class="title">대순소식 — 게시판</div>
    <span id="homeViews" class="pill">조회수 0</span>
  </div>
</header>


  <main class="container">
    <section class="card">
      <div class="inner">
        <div class="prose">
  <span class="kicker">Communication Plaza</span>
  <h1 class="hero-title">대순진리회 소통의 광장</h1>
  <p class="lead muted">도인 여러분의 소식을 기다립니다</p>
  <hr class="divider"/>

  <h3>때가 왔습니다.</h3>
  <p>오늘 우리가 이 자리에 모인 것은 분노나 분열을 위함이 아닙니다. 오직 진리의 길을 바로 세우고, 도전님의 참뜻을 지켜내기 위함입니다.</p>
  <p>종단은 한 개인의 사유물이 아닙니다. 이는 도전님께서 온 생애를 바쳐 일구신 만수 도인들의 영원한 구도의 전당이며, 후천개벽의 큰 뜻을 이루어갈 신성한 터전입니다. 그러나 지금 이 순간, 그 거룩한 법도가 무너지고 있습니다.</p>
  <div class="callout">
    <strong>난법난도(亂法亂道)의 행위 앞에서 침묵하는 것은 방관이 아니라 공범입니다.</strong><br/>
    <strong>진실을 외면하는 것은 중립이 아니라 배신입니다.</strong>
  </div>

  <h3>우리는 선택해야 합니다</h3>
  <blockquote>
    <p class="small">편안한 침묵 속에서 종단이 무너지는 것을 지켜볼 것인가,<br/>
    아니면 떨리는 목소리로라도 정의를 외치며 바른 길을 개척할 것인가.</p>
  </blockquote>
  <p>역사는 늘 소수의 깨어있는 자들에 의해 바로 세워졌습니다. 오늘 우리가 외면한 불의는 내일 짊어져야 할 업보가 될 것입니다.</p>

  <h3>이 사이트가 존재하는 이유</h3>
  <ol class="checklist">
    <li><strong>종단의 법과 제도를 바르게 알려야 합니다.</strong><br/>무지는 불의의 가장 든든한 동맹입니다. 진실을 아는 것이 변화의 시작입니다.</li>
    <li><strong>우리가 살아 있는 동안 종단 정상화를 위한 노력을 다해야 합니다.</strong><br/>다음 생을 기약할 수는 없습니다. 지금 이 순간이 우리에게 주어진 유일한 기회입니다.</li>
    <li><strong>도전님께서 납실 때까지 종단이 법과 제도에 따라 바르게 운영될 수 있도록 해야 합니다.</strong><br/>이것은 도인으로서의 의무이며, 도문소자로서의 마지막 책무입니다.</li>
  </ol>

  <h3>두려워하지 맙시다</h3>
  <p>정의를 외치는 자가 오히려 비난받는 세상입니다. 그러나 진리는 다수결로 정해지지 않으며, 정의는 힘 있는 자의 편의로 왜곡되지 않습니다.</p>
  <p>우리의 목소리가 작을지라도, 우리의 힘이 미약할지라도, 진실은 스스로 빛을 발합니다. 한 사람의 용기가 열 사람을 일으키고, 열 사람의 결의가 백 사람의 마음을 움직입니다.</p>

  <h3>함께 걸어갑시다</h3>
  <div class="summary-grid">
    <div class="item"><strong>회복의 광장</strong> — 이곳은 고발의 장이 아니라 회복의 광장입니다.</div>
    <div class="item"><strong>각성의 도량</strong> — 분노의 공간이 아니라 각성의 도량입니다.</div>
    <div class="item"><strong>재건의 밀알</strong> — 파괴의 도구가 아니라 재건의 밀알입니다.</div>
  </div>
  <p>여러분의 목소리를 들려주십시오. 여러분이 아는 진실을 나누어 주십시오. 여러분의 양심이 명령하는 바를 실천해 주십시오.<br/>
  종단의 정상화는 누군가 대신 해줄 수 없습니다. 도전님의 뜻을 지키는 것은 바로 우리, 살아있는 도인들의 책임입니다.</p>

  <h3>역사 앞에 선 우리</h3>
  <p>이제 우리는 역사 앞에 서 있습니다. 후대는 물을 것입니다. “그때 당신은 무엇을 했습니까?”<br/>
  오늘 우리의 선택이 그 답이 될 것입니다. 바른 길을 함께 걸어갑시다.</p>

  <p class="center"><strong>대순진리회 도인 여러분의 많은 의견을 모읍시다</strong><br/>
  <span class="small">대운대통(大運大通)의 그날까지, 도전님의 참뜻이 온전히 실현되는 그날까지 우리는 멈추지 않을 것입니다.</span></p>
</div>
      </div>
    </section>




  <aside class="card">
    <div class="inner">
      <h2>공지</h2>
      <ul id="noticeList" class="list"></ul>
      <div id="noticeEmpty" class="muted">등록된 공지가 없습니다.</div>
    </div>
  </aside>
</main>

<footer>© <span id="year"></span> 대순소식</footer>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot,
  doc, getDoc, setDoc, updateDoc, increment, where, getDocs
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ⬇️ 본인 Firebase 설정으로 교체(프로젝트 설정 → 일반 → 내 앱(웹))
    const firebaseConfig = {
      apiKey: "AIzaSyBiJ0DkGbirfs242W5nsVEgNroIxjCEHj0",
      authDomain: "daesoonbom-84743.firebaseapp.com",
      projectId: "daesoonbom-84743",
      storageBucket: "daesoonbom-84743.appspot.com",
      messagingSenderId: "202579781081",
      appId: "1:202579781081:web:69532923098bef8399e5c8"
    };

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const db  = getFirestore(app);

const $ = (s)=>document.querySelector(s);
$("#year").textContent = new Date().getFullYear();
const fmt = (ts)=> ts?.toDate ? ts.toDate().toLocaleString("ko-KR",{dateStyle:"medium", timeStyle:"short"}) : "";

/* 1) 홈 조회수 (세션당 1회 증가 → stats/home.views) */
(async ()=>{
  try{
    const homeBadge = $("#homeViews");
    const key = "homeViewed";
    const ref = doc(db, "stats", "home");
    if (!sessionStorage.getItem(key)){
      await setDoc(ref, { views: increment(1) }, { merge: true });
      sessionStorage.setItem(key, "1");
    }
    const snap = await getDoc(ref);
    const views = snap.exists() && snap.data().views ? snap.data().views : 1;
    if (homeBadge) homeBadge.textContent = `조회수 ${views}`;
  }catch(e){ console.warn("홈 조회수 오류:", e.message); }
})();

/* 2) 공지: 제목 클릭 시 펼치고, 펼칠 때 세션당 1회 views++ */
const noticesRef = collection(db, "notices");
const noticeUl = $("#noticeList");
const noticeEmpty = $("#noticeEmpty");

onSnapshot(query(noticesRef, orderBy("createdAt","desc")), (snap)=>{
  noticeUl.innerHTML = "";
  if (snap.empty){ noticeEmpty.style.display="block"; return; }
  noticeEmpty.style.display="none";

  snap.forEach(d=>{
    const n = d.data();
    const id = d.id;
    const li = document.createElement("li");
    li.className = "item";

    const title = document.createElement("div");
    title.className = "row";
    title.innerHTML = `
      <div class="no">공지</div>
      <div class="tit">${n.title}</div>
      <div class="meta">
        <span>${fmt(n.createdAt)}</span>
        <span class="views" id="notice-views-${id}">조회수 ${n.views || 0}</span>
      </div>
    `;

    const body = document.createElement("div");
    body.className = "body";
    body.textContent = n.body || "";

    title.querySelector(".tit").addEventListener("click", async ()=>{
      const wasOpen = body.style.display === "block";
      body.style.display = wasOpen ? "none" : "block";
      if (!wasOpen){
        const seenKey = "noticeViewed:" + id;
        if (!sessionStorage.getItem(seenKey)){
          try{
            await updateDoc(doc(db, "notices", id), { views: increment(1) });
            sessionStorage.setItem(seenKey, "1");
            const el = document.getElementById("notice-views-" + id);
            if (el){
              const cur = Number((n.views||0)) + 1;
              el.textContent = "조회수 " + cur;
              n.views = cur;
            }
          }catch(e){ console.warn("공지 조회수 증가 실패:", e.message); }
        }
      }
    });

    li.appendChild(title);
    li.appendChild(body);
    noticeUl.appendChild(li);
  });
}, (err)=>{ console.warn("공지 읽기 오류:", err.message); });

/* 3) 게시판: 페이지당 5개 + 제목 클릭 시 펼치고 세션당 1회 views++ */
const postsRef   = collection(db, "posts");
const postUl     = $("#boardList");
const boardEmpty = $("#boardEmpty");
const pagination = $("#pagination");

const PAGE_SIZE = 5;
let allPosts = [];
let currentPage = 1;

function renderPage(page=1){
  postUl.innerHTML = "";
  const start = (page-1)*PAGE_SIZE;
  const pagePosts = allPosts.slice(start, start+PAGE_SIZE);
  if (!pagePosts.length){ boardEmpty.style.display="block"; return; }
  boardEmpty.style.display="none";

  pagePosts.forEach((p, idx)=>{
    const li = document.createElement("li");
    li.className = "item";

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="no">${allPosts.length - (start + idx)}</div>
      <div class="tit">${p.title || "(제목 없음)"}</div>
      <div class="meta">
        <span>${p.author || "익명"} · ${fmt(p.createdAt)}</span>
        <span class="views" id="post-views-${p.id}">조회수 ${p.views || 0}</span>
      </div>
    `;

    const body = document.createElement("div");
    body.className = "body";
    body.textContent = p.body || "";

    row.querySelector(".tit").addEventListener("click", async ()=>{
      const wasOpen = body.style.display === "block";
      body.style.display = wasOpen ? "none" : "block";
      if (!wasOpen){
        const seenKey = "postViewed:" + p.id;
        if (!sessionStorage.getItem(seenKey)){
          try{
            await updateDoc(doc(db, "posts", p.id), { views: increment(1) });
            sessionStorage.setItem(seenKey, "1");
            const el = document.getElementById("post-views-" + p.id);
            if (el){
              const cur = Number((p.views||0)) + 1;
              el.textContent = "조회수 " + cur;
              p.views = cur;
            }
          }catch(e){ console.warn("게시글 조회수 증가 실패:", e.message); }
        }
      }
    });

    li.appendChild(row);
    li.appendChild(body);
    postUl.appendChild(li);
  });

  renderPagination(page);
}

function renderPagination(page){
  pagination.innerHTML = "";
  const totalPages = Math.max(1, Math.ceil(allPosts.length / PAGE_SIZE));
  for (let i=1; i<=totalPages; i++){
    const btn = document.createElement("button");
    btn.className = "page";
    btn.textContent = i;
    if (i===page) btn.setAttribute("aria-current","page");
    btn.addEventListener("click",()=>{ currentPage=i; renderPage(i); });
    pagination.appendChild(btn);
  }
}

onSnapshot(query(postsRef, orderBy("createdAt","desc")), (snap)=>{
  allPosts = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  renderPage(1);
}, (err)=>{ console.warn("게시판 읽기 오류:", err.message); });

/* 4) 글쓰기 (로그인 없이 유지) */
const postBtn    = document.getElementById("postBtn");
const postTitle  = document.getElementById("postTitle");
const postAuthor = document.getElementById("postAuthor");
const postBody   = document.getElementById("postBody");

postBtn.addEventListener("click", async ()=>{
  const title = (postTitle.value||"").trim();
  const author= (postAuthor.value||"").trim();
  const body  = (postBody.value||"").trim();
  if (!title || !body){ alert("제목과 내용을 입력해 주세요."); return; }
  try{
    await addDoc(postsRef, { title, author, body, views: 0, createdAt: serverTimestamp() });
    postTitle.value = ""; postAuthor.value=""; postBody.value="";
  }catch(e){
    alert("등록 실패: " + e.message);
  }
});
</script>
</body>
</html>

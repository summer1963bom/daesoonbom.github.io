<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ëŒ€ìˆœì†Œì‹ â€” ê²Œì‹œíŒ</title>
  <meta name="description" content="ë¡œê·¸ì¸ ì—†ì´ ê¸€ ì‘ì„± ê°€ëŠ¥í•œ ê³µì§€/ê²Œì‹œíŒ (Firebase Firestore)" />
  <style>
    :root{
      --bg: #0b1020; --card: #121a32; --muted: #94a3b8; --text: #e5e7eb;
      --accent: #4f46e5; --accent-2: #22d3ee; --ring: rgba(34,211,238,.35);
      --shadow: 0 20px 45px rgba(0,0,0,.35); --radius: 20px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Pretendard, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 10% 0%, rgba(79,70,229,.25), transparent 60%),
                  radial-gradient(1000px 600px at 90% 0%, rgba(34,211,238,.2), transparent 60%),
                  var(--bg);
      line-height:1.6;
    }
    a{ color: var(--accent-2); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(1.3) blur(8px);
      background: linear-gradient(to bottom, rgba(11,16,32,.9), rgba(11,16,32,.5));
      border-bottom:1px solid rgba(99,102,241,.2);
    }
    .container{ max-width:1100px; margin:0 auto; padding:24px; }
    .brand{ display:flex; align-items:center; gap:14px; }
    .logo{
      width:36px; height:36px; border-radius:50%;
      background: radial-gradient(circle at 30% 20%, #22d3ee, #4f46e5);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.15), 0 4px 16px rgba(34,211,238,.35);
    }
    .title{ font-weight:800; letter-spacing:-.02em; font-size:22px; }
    .container .muted{ color:var(--muted); }
    .grid{ display:grid; gap:24px; margin-top:24px; grid-template-columns: 1.1fr .9fr; }
    @media (max-width: 960px){ .grid{ grid-template-columns:1fr; } }
    .card{
      background: linear-gradient(180deg, rgba(18,26,50,.9), rgba(18,26,50,.8));
      border:1px solid rgba(148,163,184,.12);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card .inner{ padding:24px; }
    .card h2{ margin:0 0 12px; font-size:22px; letter-spacing:-.01em; }
    .list{ display:grid; gap:12px; padding:0; margin:0; list-style:none; }
    .item{ border:1px solid rgba(148,163,184,.12); border-radius:14px; padding:14px 16px; background: linear-gradient(180deg, rgba(18,26,50,.65), rgba(18,26,50,.5)); }
    .item h3{ margin:0 0 6px; font-size:18px; }
    .meta{ display:flex; gap:10px; font-size:12px; color:var(--muted); }
    .empty{ color:var(--muted); padding:12px; border:1px dashed rgba(148,163,184,.3); border-radius:12px; text-align:center; }
    .form{ display:grid; gap:10px; margin-top:14px; }
    .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    @media (max-width:640px){ .row{ grid-template-columns:1fr; } }
    input[type="text"], textarea{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid rgba(148,163,184,.25); background:rgba(255,255,255,.03); color:var(--text);
      outline:none; transition: box-shadow .15s ease, border-color .15s ease;
    }
    input[type="text"]:focus, textarea:focus{ border-color:var(--accent-2); box-shadow:0 0 0 4px var(--ring); }
    textarea{ min-height:110px; resize:vertical; }

    /* ê²Œì‹œíŒ ëª©ë¡(ì œëª©ë§Œ) */
    .board-item { padding: 10px 14px; border:1px solid rgba(148,163,184,.18); border-radius:12px; }
    .board-row { display:flex; gap:12px; align-items:center; }
    .board-no   { width: 48px; min-width:48px; text-align:center; font-weight:700; color:#cdd5e1; border:1px solid rgba(148,163,184,.25); border-radius:10px; padding:6px 0; }
    .board-title { cursor:pointer; font-weight:700; text-decoration:none; }
    .board-title:hover { text-decoration:underline; }
    .board-meta { margin-left:auto; font-size:12px; color:#94a3b8; }
    .board-body { display:none; margin-top:10px; color:#cbd5e1; }

    .pagination { display:flex; gap:8px; justify-content:center; margin-top:16px; flex-wrap:wrap; }
    .page-btn {
      border:1px solid rgba(148,163,184,.25); background:rgba(255,255,255,.03);
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .page-btn[aria-current="page"] { font-weight:800; border-color:#22d3ee; box-shadow:0 0 0 3px rgba(34,211,238,.25); }
    .page-btn:disabled { opacity:.5; cursor:not-allowed; }

    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; background: rgba(34,211,238,.16); border: 1px solid rgba(34,211,238,.35); color: #c0f6ff; }
    .search { display:flex; gap:10px; align-items:center; }

    /* ëª¨ë°”ì¼ ë³´ì™„ */
    @media (max-width: 640px){
      .container{ padding:14px; }
      .card .inner{ padding:16px; }
      .row{ grid-template-columns:1fr; }
      .board-no{ width:36px; min-width:36px; font-size:12px; }
      .board-title{ font-size:16px; }
      .board-meta{ font-size:11px; }
    }
    footer{ margin:40px 0 60px; text-align:center; color:var(--muted); font-size:14px; }
  </style>
</head>
<body>
  <header>
    <div class="container brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">ëŒ€ìˆœì†Œì‹</div>
      <span class="muted" style="margin-left:auto;">ë¡œê·¸ì¸ ì—†ì´ ê¸€ ì‘ì„± ê°€ëŠ¥</span>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="inner">
        <h1 style="margin:0 0 8px;">ì•ˆë…•í•˜ì„¸ìš” ğŸ‘‹ ì‚¬ì´íŠ¸ì§€ê¸°ì…ë‹ˆë‹¤.</h1>
        <p class="muted">ëˆ„êµ¬ë‚˜ ê²Œì‹œíŒì— ê¸€ì„ ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš´ì˜ ì•ˆì „ì„ ìœ„í•´ ë¶€ì ì ˆí•œ ë‚´ìš©ì€ ì‚­ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </section>

    <div class="grid">
      <!-- ê³µì§€ -->
      <section class="card" aria-labelledby="noticeTitle">
        <div class="inner">
          <h2 id="noticeTitle">ê³µì§€</h2>
          <ul id="noticeList" class="list" aria-live="polite"></ul>
          <div id="noticeEmpty" class="empty" hidden>ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          <details class="form" style="margin-top:12px;">
            <summary class="muted">ê³µì§€ ì¶”ê°€í•˜ê¸°</summary>
            <div class="row">
              <input id="noticeTitleInput" type="text" placeholder="ì œëª©" aria-label="ê³µì§€ ì œëª©" />
              <input id="noticeAuthorInput" type="text" placeholder="ì‘ì„±ì" aria-label="ê³µì§€ ì‘ì„±ì" />
            </div>
            <textarea id="noticeBodyInput" placeholder="ë‚´ìš©" aria-label="ê³µì§€ ë‚´ìš©"></textarea>
            <button class="btn" id="addNoticeBtn">ê³µì§€ ë“±ë¡</button>
          </details>
        </div>
      </section>

      <!-- ê²Œì‹œíŒ -->
      <section class="card" aria-labelledby="boardTitle">
        <div class="inner">
          <h2 id="boardTitle">ê²Œì‹œíŒ</h2>

          <div class="search" style="margin-bottom:10px;">
            <input id="searchInput" type="text" placeholder="ê²€ìƒ‰: ì œëª©/ì‘ì„±ì/ë‚´ìš©" aria-label="ê²Œì‹œíŒ ê²€ìƒ‰" />
            <span class="pill" id="countPill">0ê°œ</span>
          </div>

          <!-- ì œëª©ë§Œ ë³´ì´ëŠ” ëª©ë¡ -->
          <ul id="boardList" class="list" aria-live="polite"></ul>
          <div id="boardEmpty" class="empty" hidden>ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>

          <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
          <nav id="pagination" class="pagination" aria-label="ê²Œì‹œíŒ í˜ì´ì§€ íƒìƒ‰"></nav>

          <!-- ê¸€ì“°ê¸° -->
          <div class="form" style="margin-top:18px;">
            <div class="row">
              <input id="postTitle" type="text" placeholder="ì œëª©" aria-label="ê²Œì‹œê¸€ ì œëª©" />
              <input id="postAuthor" type="text" placeholder="ì‘ì„±ì" aria-label="ê²Œì‹œê¸€ ì‘ì„±ì" />
            </div>
            <textarea id="postBody" placeholder="ë‚´ìš©" aria-label="ê²Œì‹œê¸€ ë‚´ìš©"></textarea>
            <button class="btn" id="postBtn">ê²Œì‹œí•˜ê¸°</button>
          </div>
        </div>
      </section>
    </div>

    <footer>Â© <span id="year"></span> ëŒ€ìˆœì†Œì‹. All rights reserved.</footer>
  </main>

  <!-- ===== Firebase ì´ˆê¸°í™”(ì•± 1íšŒ) & Firestoreë§Œ ì‚¬ìš© ===== -->
  <script type="module" id="firebase-init">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // â¬‡ï¸ ë³¸ì¸ Firebase ì„¤ì •ìœ¼ë¡œ êµì²´(í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì¼ë°˜ â†’ ë‚´ ì•±(ì›¹))
    const firebaseConfig = {
      apiKey: "AIzaSyBiJ0DkGbirfs242W5nsVEgNroIxjCEHj0",
      authDomain: "daesoonbom-84743.firebaseapp.com",
      projectId: "daesoonbom-84743",
      storageBucket: "daesoonbom-84743.appspot.com",
      messagingSenderId: "202579781081",
      appId: "1:202579781081:web:69532923098bef8399e5c8"
    };


    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ì „ì—­ ë…¸ì¶œ
    window.__FIREBASE__ = { app, db };
  </script>

  <!-- ===== ì•± ë¡œì§ (ê³µì§€/ê²Œì‹œíŒ/í˜ì´ì§€ë„¤ì´ì…˜) â€” Auth ì œê±° ë²„ì „ ===== -->
  <script type="module">
    import { collection, addDoc, serverTimestamp, query, orderBy, onSnapshot }
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const { db } = window.__FIREBASE__;

    const $ = (sel) => document.querySelector(sel);
    $("#year").textContent = new Date().getFullYear();
    const fmt = (ts) => { try { if (ts?.toDate) return ts.toDate().toLocaleString("ko-KR",{dateStyle:"medium", timeStyle:"short"});} catch(_){} return ""; };

    /* -------------------- ê³µì§€ -------------------- */
    const noticesRef = collection(db, "notices");
    const noticeUl = $("#noticeList");
    const noticeEmpty = $("#noticeEmpty");

    onSnapshot(query(noticesRef, orderBy("createdAt","desc")), (snap) => {
      noticeUl.innerHTML = "";
      if (snap.empty){ noticeEmpty.hidden = false; return; }
      noticeEmpty.hidden = true;
      snap.forEach(doc => {
        const n = doc.data();
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `
          <h3>${n.title}</h3>
          <div class="meta">
            <span>ì‘ì„±ì: ${n.author || "ìµëª…"}</span>
            <span>Â·</span>
            <span>${fmt(n.createdAt)}</span>
          </div>
          <div class="muted">${(n.body||"").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("\n","<br>")}</div>
        `;
        noticeUl.appendChild(li);
      });
    }, (err) => alert("ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: " + err.message));

    $("#addNoticeBtn")?.addEventListener("click", async () => {
      const title = $("#noticeTitleInput").value.trim();
      const author = $("#noticeAuthorInput").value.trim();
      const body = $("#noticeBodyInput").value.trim();
      if (!title || !body) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      try{
        await addDoc(noticesRef, {
          title, author, body,
          createdAt: serverTimestamp()
        });
        $("#noticeTitleInput").value = "";
        $("#noticeAuthorInput").value = "";
        $("#noticeBodyInput").value = "";
      }catch(e){ alert("ë“±ë¡ ì‹¤íŒ¨: " + e.message); }
    });

    /* -------------------- ê²Œì‹œíŒ -------------------- */
    const postsRef   = collection(db, "posts");
    const postUl     = $("#boardList");
    const postEmpty  = $("#boardEmpty");
    const searchInput= $("#searchInput");
    const countPill  = $("#countPill");
    const pagination = $("#pagination");

    const postBtn    = $("#postBtn");
    const postTitle  = $("#postTitle");
    const postAuthor = $("#postAuthor");
    const postBody   = $("#postBody");

    // (ì„ íƒ) ê°„ë‹¨ ìŠ¤íŒ¸ ë°©ì§€: ê¸ˆì§€ì–´ + ì¿¨ë‹¤ìš´
    const BLOCKLIST = [/viagra/i,/ì¹´ì§€ë…¸/i,/https?:\/\/\S+/i]; // í•„ìš”ì‹œ í™•ì¥
    const POST_COOLDOWN_MS = 45 * 1000; // 45ì´ˆ
    const tooSoon = () => Date.now() - (Number(localStorage.getItem("lastPostAt")||0)) < POST_COOLDOWN_MS;
    const hasBlocked = (t,b) => BLOCKLIST.some(rx => rx.test((t||"")+ "\n" + (b||"")));

    let allPosts = [];
    let filtered = [];
    let currentPage = 1;
    const PAGE_SIZE = 10;

    const renderCount = () => { countPill.textContent = (filtered.length||0) + "ê°œ"; postEmpty.hidden = filtered.length>0; };

    function renderPage(page=1){
      currentPage = page;
      postUl.innerHTML = "";
      if (!filtered.length){ postEmpty.hidden = false; return; }
      postEmpty.hidden = true;

      const total = filtered.length;
      const start = (page - 1) * PAGE_SIZE;
      const end   = Math.min(start + PAGE_SIZE, total);
      const pageSlice = filtered.slice(start, end);

      pageSlice.forEach((p, idx) => {
        const globalNo = total - (start + idx);

        const li = document.createElement("li");
        li.className = "board-item";

        const row = document.createElement("div");
        row.className = "board-row";

        const no  = document.createElement("div");
        no.className = "board-no";
        no.textContent = globalNo;

        const title = document.createElement("a");
        title.href = "javascript:void(0)";
        title.className = "board-title";
        title.textContent = p.title || "(ì œëª© ì—†ìŒ)";

        const meta = document.createElement("div");
        meta.className = "board-meta";
        meta.textContent = `${p.author || "ìµëª…"} Â· ${fmt(p.createdAt) || ""}`;

        row.appendChild(no);
        row.appendChild(title);
        row.appendChild(meta);

        const body = document.createElement("div");
        body.className = "board-body";
        body.innerHTML = (p.body || "").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("\n","<br>");

        title.addEventListener("click", () => {
          postUl.querySelectorAll(".board-body").forEach(el => { if (el !== body) el.style.display = "none"; });
          body.style.display = (body.style.display === "block") ? "none" : "block";
        });

        li.appendChild(row);
        li.appendChild(body);
        postUl.appendChild(li);
      });
    }

    function renderPagination(){
      pagination.innerHTML = "";
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const addBtn = (label, disabled, onClick, isCurrent=false) => {
        const b = document.createElement("button");
        b.className = "page-btn"; b.textContent = label;
        if (disabled) b.disabled = true;
        if (isCurrent) b.setAttribute("aria-current","page");
        b.addEventListener("click", onClick);
        pagination.appendChild(b);
      };
      addBtn("Â« ì´ì „", currentPage<=1, ()=>{ if(currentPage>1){ renderPage(currentPage-1); renderPagination(); }});
      for (let p=1; p<=totalPages; p++){ addBtn(String(p), false, ()=>{ renderPage(p); renderPagination(); }, p===currentPage); }
      addBtn("ë‹¤ìŒ Â»", currentPage>=totalPages, ()=>{ if(currentPage<totalPages){ renderPage(currentPage+1); renderPagination(); }});
    }

    function applyFilterAndRender(){
      const q = (searchInput.value || "").trim().toLowerCase();
      filtered = (q
        ? allPosts.filter(p => [p.title, p.author, p.body].some(t => (t||"").toLowerCase().includes(q)))
        : allPosts.slice()
      ).filter(p => !hasBlocked(p.title, p.body)); // ê¸ˆì§€ì–´ ë Œë” ì°¨ë‹¨
      filtered.sort((a,b) => {
        const ad = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
        const bd = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
        return bd - ad;
      });
      renderCount(); renderPage(1); renderPagination();
    }

    onSnapshot(query(postsRef, orderBy("createdAt","desc")), (snap) => {
      allPosts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      applyFilterAndRender();
    }, (err) => alert("ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: " + err.message));

    searchInput.addEventListener("input", () => applyFilterAndRender());

    postBtn.addEventListener("click", async () => {
      const title = postTitle.value.trim();
      const author= postAuthor.value.trim();
      const body  = postBody.value.trim();
      if (!title || !body) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      if (hasBlocked(title, body)) return alert("ê¸ˆì§€ëœ ë¬¸êµ¬(ë˜ëŠ” ë§í¬)ê°€ í¬í•¨ë˜ì–´ ê²Œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      if (tooSoon()) {
        const last = Number(localStorage.getItem("lastPostAt")||0);
        const left = Math.ceil((POST_COOLDOWN_MS - (Date.now()-last))/1000);
        return alert(`ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (${left}ì´ˆ)`);
      }
      try {
        await addDoc(postsRef, {
          title, author, body,
          createdAt: serverTimestamp()
        });
        localStorage.setItem("lastPostAt", Date.now());
        postTitle.value = ""; postAuthor.value = ""; postBody.value = "";
      } catch (e) {
        alert("ë“±ë¡ ì‹¤íŒ¨: " + e.message);
      }
    });
  </script>
</body>
</html>
